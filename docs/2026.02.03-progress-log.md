# QA Progress Log - February 3, 2026

## Issue #1: Settings - Household Members Not Editable

**Status:** ðŸŸ¢ Fixed

**Problem:**
- Can't edit household family members in settings
- Can't add new family members
- Previously saw a list of family members with preferences in onboarding that was editable - can't find it now
- All onboarding-gathered context (family members, preferences) should be editable somewhere

**Investigation:**
- [x] Check current settings page implementation
- [x] Find where family profile data is stored
- [x] Determine what onboarding collects
- [x] Make household members editable in settings

**Fix Applied:**
1. Updated `/settings` page:
   - Family members now clickable to edit (shows name + dietary preferences)
   - Added "Add" button to add new family members
   - Edit modal with name, dietary preferences fields
   - Delete option in edit modal
2. Created new `/settings/family-profile` page:
   - Shows Zylo's summary of the family
   - View/edit all onboarding-gathered data:
     - Location (city, region)
     - Shopping preferences (stores, frequency, budget level)
     - Health & dietary (conditions, restrictions, allergies, food values)
     - Family dynamics (primary cook, picky eaters, meal schedule)
     - Cooking capacity (energy level, weeknight time, weekend flexibility, batch cooking)
   - "Edit" button toggles between view and edit modes
3. Added "Zylo's Memory" section on main settings page linking to family profile

**Files Changed:**
- `src/app/settings/page.tsx` - Updated with editable members + link to profile
- `src/app/settings/family-profile/page.tsx` - New page for viewing/editing profile

**Verified:** â¬œ Waiting for user confirmation

---

## Issue #2: Auto-focus Input Fields in Modals

**Status:** ðŸŸ¢ Fixed

**Problem:**
- When modals open, cursor is not in the input field
- User has to click into the field before typing

**Fix Applied:**
1. Added `autoFocus` to name input in Add/Edit Family Member modal
2. Added UX Preferences section to `CLAUDE.md` with auto-focus rule for future development

**Files Changed:**
- `src/app/settings/page.tsx` - Added autoFocus to name input
- `CLAUDE.md` - Added UX Preferences section

**Verified:** âœ… Fixed

---

## Issue #3: Meal Details Missing Directions

**Status:** ðŸŸ¢ Fixed

**Problem:**
- Meal detail view shows ingredients but not cooking directions
- "Plan" section shows unhelpful generic text: "Keep it simple: prep a few things, cook, and call it a win."
- Hard to gauge how involved a meal is

**Root Cause:**
- AI generation prompts never requested cooking steps
- `weekly-planning/page.tsx` hardcoded `steps: []` when saving meals
- Meals created through normal workflow had no steps data

**Fix Applied:**
1. Updated AI generation (`convex/ai.ts`):
   - Added `steps: v.array(v.string())` to return schemas for all 3 actions
   - Updated prompts to request steps in JSON format
   - Added fallback parsing: `steps: meal.steps || []`
   - Actions fixed: `generateWeekPlan`, `quickGeneratePlan`, `generatePlanWithConversation`
2. Updated `weekly-planning/page.tsx`:
   - Changed from `steps: []` to `steps: meal.steps || []` in 3 places where meals are saved
3. Improved `MealOptionDetails.tsx`:
   - Changed section title from "Plan" to "Directions"
   - Added `getEffortDescription()` helper for better fallback text
   - Shows effort-appropriate description when steps are missing (for old meals)
4. Added Convex mutations to manage meal steps:
   - `updateMealSteps` - Update steps for existing meals
   - `listAllMeals` - List all meals with steps status

**Files Changed:**
- `convex/ai.ts` - Updated all 3 AI generation actions to include steps
- `src/app/weekly-planning/page.tsx` - Wire through AI-generated steps
- `src/components/meal-helper/MealOptionDetails.tsx` - Better directions display
- `convex/weekPlans.ts` - Added step management mutations

**To Test:**
1. Go to Plan tab and generate a new meal plan
2. Click on a meal to view details
3. Verify "Directions" section shows numbered cooking steps

**Verified:** â¬œ Waiting for user confirmation

---

## Issue #4: Zylo Chat Gives Canned Response Instead of AI

**Status:** ðŸŸ¢ Fixed

**Problem:**
- When Zylo asks a question and user replies, Zylo gives a stock response instead of processing with AI
- User types "dont need tonight... regular engergy" and Zylo responds with canned "Got it! Feel free to share more..."
- Should give an AI-generated response that acknowledges the user's specific input

**Root Cause:**
- In `handleSendMessage`, when user types in "idle" mode, code switched to "discuss" mode but returned with a canned response
- AI processing only happened on the SECOND message (when already in "discuss" mode)

**Fix Applied:**
- Removed the early `return` after switching to "discuss" mode
- Now falls through to AI processing for the first message too
- Changed condition to check for both modes: `planningMode === "discuss" || planningMode === "idle"`

**Files Changed:**
- `src/app/weekly-planning/page.tsx` - Fixed handleSendMessage to process first message with AI

**Verified:** â¬œ Waiting for user confirmation

---

## Issue #5: Edit Day Modal UX Problems

**Status:** ðŸŸ¢ Fixed

**Problems:**
1. Can't click on current meal to see ingredients/directions
2. "No quick swap options available" message is confusing - makes it seem broken
3. After swapping to a new meal, still no directions visible
4. Steps data not being passed through to the weekly-planning PlannedMeal type

**Fixes Applied:**

1. **Made current meal clickable** - Added `onViewMealDetails` prop to EditDayModal
   - Current meal card is now a button
   - Shows "Tap to see ingredients & directions â†’" hint
   - Opens MealOptionDetails view with back button

2. **Fixed confusing empty alternatives message** - Changed from passive "No quick swap options available" to an actionable tappable card:
   - Shows sparkle icon
   - "Tap to find alternatives"
   - "Zylo will suggest meals similar to [meal name]"
   - Clicking it triggers the same action as "More options"

3. **Added steps to PlannedMeal type** - Updated weekly-planning type and adapter
   - Added `steps: string[]` and `briefInstructions?: string` to PlannedMeal interface
   - Updated `toWeeklyPlannedMeal` adapter to include `steps: meal.steps || []`

**Files Changed:**
- `src/components/weekly-planning/EditDayModal.tsx` - Clickable meal + better empty state
- `src/app/weekly-planning/page.tsx` - Added MealOptionDetails view for meal details
- `src/types/weekly-planning.ts` - Added steps and briefInstructions to PlannedMeal
- `src/lib/meal-adapters.ts` - Pass through steps data

**Note:** Existing meals in database still won't have steps (need to generate new meals or backfill). New meals generated going forward will have steps.

**Verified:** â¬œ Waiting for user confirmation

---

## Issue #6: One-Click View Meal from Plan Page

**Status:** ðŸŸ¢ Fixed

**Problem:**
- Viewing meal details from Plan page required 2 clicks (day card â†’ Edit modal â†’ click current meal)
- User wants ONE click to see ingredients/directions
- Home page shows directions correctly, but Plan page flow wasn't working

**Fixes Applied:**

1. **Added "View ingredients & directions" link on each DayCard**
   - Eye icon + text link below the cook/eaters info
   - Clicking it goes directly to MealOptionDetails view
   - Uses `stopPropagation` so it doesn't also trigger the Edit Day modal

2. **Wired up the new `onViewMeal` callback**
   - Added `onViewMeal` prop to DayCard and WeekPlanViewProps
   - When clicked, directly opens meal details (skips Edit Day modal)

**Files Changed:**
- `src/components/weekly-planning/DayCard.tsx` - Added Eye icon and view link
- `src/components/weekly-planning/WeekPlanView.tsx` - Pass onViewMeal to DayCard
- `src/types/weekly-planning.ts` - Added onViewMeal to WeekPlanViewProps
- `src/app/weekly-planning/page.tsx` - Wire up onViewMeal handler

**Verified:** â¬œ Waiting for user confirmation

---

## Issue #7: Meal Swap Doesn't Update Ingredients/Steps (CRITICAL)

**Status:** ðŸŸ¢ Fixed

**Problem:**
- When swapping a meal (e.g., Quesadillas â†’ Homemade Pizza), only the name and metadata changed
- Ingredients and directions stayed from the OLD meal
- Result: "Homemade Pizza" showed quesadilla directions ("sprinkle cheese onto a tortilla")

**Root Cause:**
- AI `suggestAlternatives` action only returned name/effort/time, not ingredients or steps
- `MealAlternative` type didn't include ingredients or steps
- Swap handler didn't pass ingredients/steps to updateMeal mutation

**Fixes Applied:**

1. **Updated AI action** (`convex/ai.ts`):
   - Added ingredients and steps to return schema
   - Updated prompt to request ingredients (4-8 items) and steps (3-6 steps)
   - Increased max_tokens from 800 to 1500 for fuller responses

2. **Updated MealAlternative type** (`src/types/weekly-planning.ts`):
   - Added `ingredients: string[]` and `steps: string[]`

3. **Updated swap handler** (`src/app/weekly-planning/page.tsx`):
   - handleMoreOptions includes ingredients/steps from AI response
   - handleSelectAlternative passes ingredients/steps to updateMeal mutation

**Files Changed:**
- `convex/ai.ts` - suggestAlternatives returns ingredients & steps
- `src/types/weekly-planning.ts` - MealAlternative includes ingredients & steps
- `src/app/weekly-planning/page.tsx` - Wire through ingredients & steps on swap

**Verified:** â¬œ Waiting for user confirmation

---

## Issue #8: Home Page "View Details" for Tomorrow's Meal

**Status:** ðŸŸ¢ Fixed

**Problem:**
- On Home page, "View Details" button for tomorrow's meal showed a chat message
- Should show the full meal details view (ingredients, directions) like tonight's meal

**Fix Applied:**
- Added `detailMeal` state to track which meal to show in details view
- Updated all navigation to details view to set `detailMeal` first
- `handleViewTomorrow` now sets `detailMeal = tomorrowMeal` and shows details view

**Files Changed:**
- `src/app/page.tsx` - Added detailMeal state, updated handlers

**Verified:** â¬œ Waiting for user confirmation

---

## Session Summary

**8 issues identified and fixed** through manual QA testing.

**Key finding:** The data model has inconsistencies across multiple "meal" types that caused cascading bugs. A data model audit is needed before adding new features.

**Handoff created:** `docs/handoffs/2025-02-03-qa-session.md`

**Priority for next session:** Audit and consolidate meal-related types across:
- Convex schema
- TypeScript types (PlannedMeal, PlannedMealSummary, MealAlternative)
- Adapters
- AI action return types

---

## Data Model Consolidation - February 3, 2026 (Session 2)

**Status:** ðŸŸ¢ Complete

### The Problem

The app had **3 different meal type representations** with inconsistent field names and lossy conversions:

| Issue | Database (Convex) | UI Types |
|-------|-------------------|----------|
| Name field | `name` | `mealName` |
| Cook field | `cookId` | `assignedCookId` |
| Steps field | `steps` | `prepSteps` (sometimes) |
| Cleanup rating | `1 \| 2 \| 3` (numeric) | `"low" \| "medium" \| "high"` (string) |
| **Ingredients** | `{name, quantity, isOrganic}[]` | `string[]` (names only!) |

**Biggest bug:** Ingredient quantities were being thrown away in the adapters, so users could never see "2 cups flour" - only "flour".

### Types Audited

1. **Convex Schema** (`convex/schema.ts`) - `plannedMeals` table
2. **Weekly Planning Types** (`src/types/weekly-planning.ts`) - `PlannedMeal`, `MealAlternative`
3. **Meal Helper Types** (`src/types/meal-helper.ts`) - `PlannedMealSummary`, `MealSuggestion`
4. **Adapters** (`src/lib/meal-adapters.ts`) - `toPlannedMealSummary`, `toWeeklyPlannedMeal`
5. **AI Actions** (`convex/ai.ts`) - return types from `suggestAlternatives`, `generateWeekPlan`, etc.

### Solution Implemented

**1. Created Canonical Meal Type** (`src/types/meal.ts`)

New single-source-of-truth file containing:
- `Ingredient` type: `{ name: string; quantity: string; isOrganic?: boolean }`
- `Meal` interface matching Convex schema exactly
- `CleanupRatingNumeric` (1|2|3) and `CleanupRatingDisplay` ("low"|"medium"|"high")
- Mapping functions: `cleanupRatingToDisplay`, `cleanupRatingToNumeric`
- Helper functions: `toMealDisplay()`, `fromMealDisplay()`, `getIngredientNames()`, `formatIngredient()`

**2. Updated Adapters** (`src/lib/meal-adapters.ts`)

- Import from canonical `meal.ts`
- **FIXED:** `toWeeklyPlannedMeal` now preserves full `Ingredient[]` objects (not just names)
- **FIXED:** `toPlannedMealSummary` now preserves full `Ingredient[]` objects
- Added `MealSummaryLegacy` type for backwards compatibility
- Added `ingredientNames` field for consumers that need flattened names

**3. Consolidated UI Types**

Updated both files to import from canonical type and use `Ingredient[]`:

- `src/types/weekly-planning.ts`:
  - `PlannedMeal.ingredients` â†’ `Ingredient[]`
  - `MealAlternative.ingredients` â†’ `Ingredient[]`
  - Removed dead fields: `isUnplanned`, `briefInstructions`

- `src/types/meal-helper.ts`:
  - `PlannedMealSummary.ingredients` â†’ `Ingredient[]`
  - `MealSuggestion.ingredients` â†’ `Ingredient[]`
  - Removed dead field: `isKidFriendly`

**4. Updated All Consuming Components**

| Component | Changes |
|-----------|---------|
| `MealOptionDetails.tsx` | Added `formatIngredientDisplay()` helper, render `ingredient.name` |
| `TonightPlanCard.tsx` | Removed `isKidFriendly` badge, use `ingredient.name` |
| `MealSuggestionCard.tsx` | Use `ingredient.name` for key and display |
| `IngredientsCheckPanel.tsx` | Use `ingredient.name` for checks and display |
| `DayCard.tsx` | Removed all `isUnplanned` references |
| `page.tsx` (Home) | Map ingredients to names where needed for string contexts |
| `weekly-planning/page.tsx` | Map AI string responses to `Ingredient` objects, extract names for Sets |

### Files Changed

**New Files:**
- `src/types/meal.ts` - Canonical meal type definitions

**Modified Files:**
- `src/types/weekly-planning.ts` - Use canonical types, remove dead fields
- `src/types/meal-helper.ts` - Use canonical types, remove dead fields
- `src/lib/meal-adapters.ts` - Preserve full ingredients, import canonical types
- `src/components/meal-helper/MealOptionDetails.tsx` - Handle Ingredient objects
- `src/components/meal-helper/TonightPlanCard.tsx` - Handle Ingredient objects, remove isKidFriendly
- `src/components/meal-helper/MealSuggestionCard.tsx` - Handle Ingredient objects
- `src/components/meal-helper/IngredientsCheckPanel.tsx` - Handle Ingredient objects
- `src/components/weekly-planning/DayCard.tsx` - Remove isUnplanned references
- `src/app/page.tsx` - Extract ingredient names where needed
- `src/app/weekly-planning/page.tsx` - Map between string and Ingredient types

### Before/After

**Before (data loss):**
```typescript
// Adapter threw away quantity data
ingredients: meal.ingredients.map((ing) => ing.name) // ["flour", "eggs"]
```

**After (full data preserved):**
```typescript
// Adapter preserves full objects
ingredients: meal.ingredients // [{name: "flour", quantity: "2 cups"}, ...]
```

### Verification

- TypeScript compiler passes with no errors (`npx tsc --noEmit`)
- All meal types now flow through canonical definitions
- Ingredient quantities will be preserved for new meals going forward

### Known Limitations

- **Existing meals in database** may have empty quantities if they were created before this fix
- **AI actions** (`convex/ai.ts`) still return `string[]` for ingredients - they get mapped to `Ingredient` objects with empty quantities in the page handlers. A future improvement could have the AI return full ingredient objects.

---

## Codebase Audit - February 3, 2026 (Session 2, Part 2)

**Status:** ðŸŸ¢ Critical Items Fixed

### Audit Summary

A senior-dev-level audit of the entire codebase found **29 issues** across 9 categories:

| Category | Critical | High | Medium | Low |
|----------|----------|------|--------|-----|
| Code Duplication | - | 1 | 2 | - |
| Type Safety | - | - | - | 3 |
| Brittle Code | - | 1 | 2 | 1 |
| Dead Code | - | - | - | 3 |
| Performance | - | 1 | 1 | 1 |
| Error Handling | - | 2 | 1 | - |
| Security | - | 1 | 2 | - |
| Architecture | - | 1 | 2 | - |
| Code Smells | - | - | - | 4 |

### Critical Items Being Fixed

#### 1. No Error Boundary
**Problem:** One component crash kills the entire app.
**Fix:** Add React Error Boundary wrapper.

#### 2. No Rate Limiting on AI Actions
**Problem:** Users can spam AI requests â†’ huge API bills.
**Fix:** Add debouncing on client-side AI action triggers.

#### 3. Duplicate Date Logic
**Problem:** Monday calculation repeated 3+ times across files with timezone risks.
**Files:** `convex/weekPlans.ts`, `src/app/weekly-planning/page.tsx`, `src/lib/meal-adapters.ts`
**Fix:** Extract to `src/lib/dateUtils.ts` and import everywhere.

#### 4. Duplicate HouseholdMember Type
**Problem:** Same interface defined in two files.
**Files:** `src/types/meal-helper.ts` (line 10-15), `src/types/weekly-planning.ts` (line 15-20)
**Fix:** Define once in `src/types/household.ts`, re-export from both.

### Critical Items - Fixes Applied

#### 1. Error Boundary - FIXED
**Files Created:**
- `src/components/ErrorBoundary.tsx` - React class component with friendly fallback UI

**Files Modified:**
- `src/app/layout.tsx` - Wrapped app content with ErrorBoundary

**Details:**
- Catches JavaScript errors in component tree
- Shows "Something went wrong" with Try Again button
- Uses app's CSS variables for consistent styling
- Logs errors to console for debugging

#### 2. AI Rate Limiting - FIXED
**Files Created:**
- `src/lib/useDebounce.ts` - `useDebouncedCallback` and `useThrottledCallback` hooks

**Files Modified:**
- `src/app/weekly-planning/page.tsx` - Added throttling to AI calls:
  - `generateWeekPlan` / `quickGeneratePlan`: 2000ms debounce
  - `suggestAlternatives`: 1500ms debounce
- `src/app/page.tsx` - Added 1000ms debounce to AI chat

**Details:**
- Uses refs to track last call time
- Immediate first execution, ignores rapid repeats
- Prevents spam clicks from triggering multiple API calls

#### 3. Date Utilities Extraction - FIXED
**Files Created:**
- `src/lib/dateUtils.ts` - Canonical date utility functions with JSDoc

**Files Modified:**
- `src/lib/meal-adapters.ts` - Removed duplicate functions, imports from dateUtils
- `src/components/weekly-planning/WeekPlanView.tsx` - Uses getTodayString() from dateUtils
- `convex/weekPlans.ts` - Added documentation pointing to canonical implementation

**Functions in dateUtils.ts:**
- `getMondayOfWeek(date)` - Get Monday of week containing date
- `formatDateLocal(date)` - Format as YYYY-MM-DD in local timezone
- `getTodayString()` - Today as YYYY-MM-DD
- `getCurrentWeekStart()` - This week's Monday
- `getTomorrowString()` - Tomorrow as YYYY-MM-DD

#### 4. HouseholdMember Consolidation - FIXED
**Files Created:**
- `src/types/household.ts` - Canonical HouseholdMember interface

**Files Modified:**
- `src/types/meal-helper.ts` - Imports and re-exports from household.ts
- `src/types/weekly-planning.ts` - Imports and re-exports from household.ts

**Note:** Settings and onboarding have different HouseholdMember shapes (with Convex IDs, dietary preferences) - these remain as local types since they serve different purposes.

### High Priority Items - Fixes Applied

#### 1. N+1 Query Pattern - FIXED
**Files Modified:**
- `src/app/page.tsx` - Sort callback now uses Map for O(1) lookups
- `src/app/weekly-planning/page.tsx` - Two loops now use Set for O(1) date checks

**Details:**
- Replaced `.find()` inside sort/loop callbacks with Map/Set lookups
- 3 O(nÂ²) patterns fixed to O(n)

#### 2. Silent Failures - FIXED
**Files Created:**
- `src/lib/errorUtils.ts` - `extractErrorMessage()` and `formatErrorForUser()` helpers

**Files Modified:**
- `src/app/page.tsx` - 5 catch blocks now show helpful error context
- `src/app/weekly-planning/page.tsx` - 7 catch blocks improved

**Details:**
- Extracts user-friendly message from errors
- Strips technical prefixes (ConvexError:, Uncaught, etc.)
- Truncates long messages
- Format: "Couldn't [action]: [specific error]"

#### 3. Console.logs Cleanup - FIXED
**Files Modified:**
- `convex/weekPlans.ts` - Removed 6 debug console.log statements

**Details:**
- Removed verbose data flow logging from `getCurrentWeekWithMeals`
- Improved comments to explain fallback logic

#### 4. God Component - FIXED
**Status:** Refactored into custom hooks

**Before:** 1253 lines in one file
**After:** 657 lines in page.tsx + 970 lines in hooks file

**Files Created:**
- `src/hooks/useWeekPlanning.ts` - Three custom hooks:
  - `useWeekPlanData` - All Convex queries and data transformations
  - `useWeekPlanState` - All 11 useState hooks for UI state
  - `usePlanningAI` - AI action orchestration with debouncing

**Results:**
| Metric | Before | After |
|--------|--------|-------|
| page.tsx lines | 1253 | 657 |
| Reduction | - | 47.6% |

**Benefits:**
- Separation of concerns (data, state, AI are now separate)
- Each hook can be tested independently
- Main page is now a thin orchestrator
- All TypeScript types preserved

### Medium Priority Items

1. AI prompts repeated 3x with 80% identical content
2. Magic numbers without constants (slice(-10), 300 tokens, 14 days)
3. `handleSendMessage` is 145 lines with deep nesting
4. Missing input validation on Convex mutations
5. `seedSampleWeekPlan` exposed to production clients

### Strengths Noted

- Excellent canonical type system (from earlier consolidation)
- Good Convex real-time patterns
- Clean component composition in most places
- Thoughtful, warm error message tone
- Smart AI context injection

---
